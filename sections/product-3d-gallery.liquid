{% comment %}
  3D Product Gallery - Full-width immersive 3D product experience
  Features split-screen layout with 3D model and product details
{% endcomment %}

{{ 'component-model-viewer.css' | asset_url | stylesheet_tag }}

<section class="min-h-screen flex items-center py-12 md:py-0 bg-gradient-to-br from-primary via-gradient1 to-secondary" data-section-id="{{ section.id }}" data-section-type="product-3d-gallery">
  
  {%- assign product = all_products[section.settings.product] -%}
  
  {%- if product != blank -%}
    <div class="container-flux">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-16 items-center">
        
        <!-- 3D Model Side -->
        <div class="order-2 lg:order-1">
          <div class="sticky top-24">
            {%- assign has_3d_model = false -%}
            {%- assign model_media = null -%}
            
            {%- for media in product.media -%}
              {%- if media.media_type == 'model' -%}
                {%- assign has_3d_model = true -%}
                {%- assign model_media = media -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}

            {%- if has_3d_model -%}
              <!-- 3D Model Container -->
              <div class="relative aspect-square rounded-2xl overflow-hidden border-2 border-accent/30 shadow-glow-lg">
                {%- render 'product-3d-model', media: model_media, loop: section.settings.auto_rotate, reveal: 'auto' -%}
              </div>

              <!-- Model Controls Info -->
              <div class="mt-6 p-4 bg-secondary/50 backdrop-blur-sm border border-accent/20 rounded-xl">
                <div class="flex items-start gap-3">
                  <svg class="w-6 h-6 text-accent flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <div class="flex-1">
                    <p class="text-sm font-semibold mb-2 text-accent">{{ 'products.product.3d_controls' | t }}</p>
                    <ul class="text-xs text-muted space-y-1">
                      <li>• Drag to rotate the model</li>
                      <li>• Pinch or scroll to zoom</li>
                      <li>• Tap AR button to view in your space (mobile)</li>
                      <li>• Double-tap to reset view</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Additional Model Images -->
              {%- if section.settings.show_thumbnails -%}
                <div class="mt-4 grid grid-cols-4 gap-2">
                  {%- for media in product.media limit: 4 -%}
                    {%- if media.media_type == 'image' -%}
                      <div class="aspect-square rounded-lg overflow-hidden border border-border hover:border-accent transition-colors duration-300">
                        <img
                          src="{{ media | image_url: width: 200 }}"
                          alt="{{ media.alt | escape }}"
                          loading="lazy"
                          width="200"
                          height="200"
                          class="w-full h-full object-cover"
                        >
                      </div>
                    {%- endif -%}
                  {%- endfor -%}
                </div>
              {%- endif -%}

            {%- else -%}
              <!-- Fallback if no 3D model -->
              <div class="aspect-square rounded-2xl overflow-hidden bg-secondary border border-border">
                {%- if product.featured_media -%}
                  <img
                    src="{{ product.featured_media | image_url: width: 1000 }}"
                    alt="{{ product.featured_media.alt | escape }}"
                    loading="eager"
                    width="{{ product.featured_media.width }}"
                    height="{{ product.featured_media.height }}"
                    class="w-full h-full object-cover"
                  >
                {%- else -%}
                  {{ 'product-1' | placeholder_svg_tag: 'w-full h-full opacity-20' }}
                {%- endif -%}
              </div>
              
              <div class="mt-4 p-4 bg-secondary/50 border border-border rounded-xl text-center">
                <p class="text-muted text-sm">
                  {{ 'products.product.no_3d_model' | t }}
                </p>
              </div>
            {%- endif -%}
          </div>
        </div>

        <!-- Product Details Side -->
        <div class="order-1 lg:order-2 space-y-6">
          
          {%- if product.vendor != blank and section.settings.show_vendor -%}
            <p class="text-sm text-accent uppercase tracking-wide font-semibold">{{ product.vendor }}</p>
          {%- endif -%}

          <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold leading-tight">
            {{ product.title }}
          </h1>

          <!-- Price -->
          <div class="flex items-center gap-4">
            <span class="text-4xl font-bold bg-flux-gradient bg-clip-text text-transparent">
              {{ product.price | money }}
            </span>
            
            {%- if product.compare_at_price > product.price -%}
              <span class="text-xl text-muted line-through">
                {{ product.compare_at_price | money }}
              </span>
            {%- endif -%}
          </div>

          <!-- 3D & AR Badge -->
          {%- if has_3d_model -%}
            <div class="inline-flex items-center gap-2 px-4 py-2 bg-accent/10 border border-accent/30 rounded-xl">
              <svg class="w-5 h-5 text-accent" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
              </svg>
              <span class="text-sm font-semibold text-accent">{{ 'products.product.3d_available' | t }}</span>
            </div>
          {%- endif -%}

          <!-- Description -->
          {%- if product.description != blank -%}
            <div class="prose prose-invert max-w-none text-muted">
              {{ product.description }}
            </div>
          {%- endif -%}

          <!-- Features List -->
          {%- if section.settings.show_features -%}
            <div class="space-y-3 py-6 border-y border-border">
              <div class="flex items-center gap-3 text-sm">
                <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>{{ 'products.product.feature_1' | t }}</span>
              </div>
              <div class="flex items-center gap-3 text-sm">
                <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>{{ 'products.product.feature_2' | t }}</span>
              </div>
              <div class="flex items-center gap-3 text-sm">
                <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>{{ 'products.product.feature_3' | t }}</span>
              </div>
            </div>
          {%- endif -%}

          <!-- CTA Button -->
          <a href="{{ product.url }}" class="btn btn-primary w-full md:w-auto text-center inline-block text-lg py-4 px-8">
            {{ section.settings.button_text | default: 'View Product Details' }}
          </a>
        </div>
      </div>
    </div>

  {%- else -%}
    <!-- No Product Selected -->
    <div class="container-flux">
      <div class="text-center py-16 bg-secondary rounded-2xl border-2 border-dashed border-border">
        <svg class="w-16 h-16 mx-auto mb-4 text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
        </svg>
        <p class="text-muted">{{ 'sections.product_3d_gallery.no_product' | t }}</p>
      </div>
    </div>
  {%- endif -%}
</section>

<!-- Load Shopify's Model Viewer UI -->
<script type="module" src="https://cdn.shopify.com/shopifycloud/model-viewer-ui/assets/v1.0/model-viewer.js"></script>

{% schema %}
{
  "name": "3D Product Gallery",
  "tag": "section",
  "class": "product-3d-gallery-section",
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Product with 3D model",
      "info": "Select a product that has 3D models uploaded (GLB/USDZ format)"
    },
    {
      "type": "checkbox",
      "id": "auto_rotate",
      "label": "Auto-rotate 3D model",
      "default": true,
      "info": "Model will slowly rotate automatically"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show vendor",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_features",
      "label": "Show feature highlights",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_thumbnails",
      "label": "Show product image thumbnails",
      "default": true
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "View Full Details"
    }
  ],
  "presets": [
    {
      "name": "3D Product Gallery"
    }
  ]
}
{% endschema %}

