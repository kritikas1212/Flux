{% comment %}
  3D Product Showcase Section
  Displays products with 3D models and AR (Augmented Reality) support
  Supports GLB (web/Android) and USDZ (iOS/AR) formats
  Reference: https://shopify.dev/docs/themes/architecture/templates/product
{% endcomment %}

{{ 'component-model-viewer.css' | asset_url | stylesheet_tag }}

<section class="section-spacing relative overflow-hidden" data-section-id="{{ section.id }}" data-section-type="product-3d-showcase">
  
  <!-- Animated Background -->
  <div class="absolute inset-0 bg-gradient-to-br from-primary via-gradient1 to-gradient2"></div>
  <div class="absolute top-0 right-0 w-96 h-96 bg-accent rounded-full blur-3xl opacity-10 animate-glow-pulse"></div>
  <div class="absolute bottom-0 left-0 w-96 h-96 bg-accent-light rounded-full blur-3xl opacity-10 animate-glow-pulse" style="animation-delay: 1s;"></div>

  <div class="container-flux relative z-10">
    
    <!-- Section Header -->
    {%- if section.settings.heading != blank -%}
      <div class="text-center mb-16 animate-fade-in-up">
        <h2 class="mb-4">
          <span class="bg-flux-gradient bg-clip-text text-transparent">
            {{ section.settings.heading }}
          </span>
        </h2>
        
        {%- if section.settings.subheading != blank -%}
          <p class="text-muted text-lg max-w-3xl mx-auto">
            {{ section.settings.subheading }}
          </p>
        {%- endif -%}
      </div>
    {%- endif -%}

    <!-- 3D Products Grid -->
    <div class="grid grid-cols-1 md:grid-cols-{{ section.settings.columns_desktop }} gap-8 lg:gap-12">
      {%- for block in section.blocks -%}
        {%- assign product = all_products[block.settings.product] -%}
        
        {%- if product != blank -%}
          <div 
            class="group relative animate-fade-in-up" 
            style="animation-delay: {{ forloop.index | times: 150 }}ms;"
            {{ block.shopify_attributes }}
          >
            <!-- 3D Model Container -->
            <div class="relative rounded-2xl overflow-hidden bg-secondary border-2 border-border hover:border-accent transition-all duration-500 shadow-glow hover:shadow-glow-lg">
              
              {%- assign has_3d_model = false -%}
              {%- for media in product.media -%}
                {%- if media.media_type == 'model' -%}
                  {%- assign has_3d_model = true -%}
                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}

              {%- if has_3d_model -%}
                <!-- 3D Model Viewer -->
                <div class="relative aspect-square bg-gradient-to-br from-gradient1 to-gradient2">
                  {%- for media in product.media -%}
                    {%- if media.media_type == 'model' -%}
                      <div class="absolute inset-0">
                        {{ media | model_viewer_tag:
                          image_size: '1024x',
                          reveal: 'interaction',
                          toggleable: true,
                          data-model-id: media.id,
                          interaction-prompt-threshold: 0,
                          ar: true,
                          loading: 'lazy',
                          poster: media.preview_image | image_url: width: 1024,
                          alt: media.alt | escape
                        }}
                      </div>
                      {%- break -%}
                    {%- endif -%}
                  {%- endfor -%}

                  <!-- AR Badge -->
                  <div class="absolute top-4 right-4 px-3 py-2 bg-accent text-white text-xs font-bold rounded-lg shadow-lg flex items-center gap-2 animate-fade-in">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                    </svg>
                    3D & AR
                  </div>

                  <!-- View in AR Button (Mobile) -->
                  <button
                    class="model-viewer-ar-button absolute bottom-4 left-1/2 -translate-x-1/2 px-6 py-3 bg-flux-gradient text-white font-semibold rounded-xl shadow-glow hover:shadow-glow-lg transition-all duration-300 flex items-center gap-2"
                    type="button"
                    aria-label="View in your space"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    {{ 'products.product.view_in_space' | t }}
                  </button>
                </div>

                <!-- 3D Model Controls Info -->
                <div class="absolute bottom-20 left-4 right-4 bg-secondary/90 backdrop-blur-sm border border-accent/30 rounded-xl p-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  <p class="text-xs text-center text-muted">
                    <strong class="text-accent">{{ 'products.product.3d_controls' | t }}</strong><br>
                    {{ 'products.product.3d_instructions' | t }}
                  </p>
                </div>

              {%- else -%}
                <!-- Fallback to Regular Image -->
                {%- if product.featured_media -%}
                  <div class="aspect-square">
                    <img
                      srcset="
                        {%- if product.featured_media.width >= 360 -%}{{ product.featured_media | image_url: width: 360 }} 360w,{%- endif -%}
                        {%- if product.featured_media.width >= 533 -%}{{ product.featured_media | image_url: width: 533 }} 533w,{%- endif -%}
                        {%- if product.featured_media.width >= 720 -%}{{ product.featured_media | image_url: width: 720 }} 720w,{%- endif -%}
                        {%- if product.featured_media.width >= 1024 -%}{{ product.featured_media | image_url: width: 1024 }} 1024w,{%- endif -%}
                        {{ product.featured_media | image_url }} {{ product.featured_media.width }}w
                      "
                      sizes="(min-width: 1024px) {{ 100 | divided_by: section.settings.columns_desktop }}vw, 100vw"
                      src="{{ product.featured_media | image_url: width: 720 }}"
                      alt="{{ product.featured_media.alt | escape }}"
                      loading="lazy"
                      width="{{ product.featured_media.width }}"
                      height="{{ product.featured_media.height }}"
                      class="w-full h-full object-cover"
                    >
                  </div>
                {%- endif -%}
              {%- endif -%}
            </div>

            <!-- Product Info -->
            <div class="mt-6 space-y-3">
              {%- if section.settings.show_vendor and product.vendor != blank -%}
                <p class="text-xs text-accent uppercase tracking-wide font-semibold">{{ product.vendor }}</p>
              {%- endif -%}

              <h3 class="text-xl font-bold">
                <a href="{{ product.url }}" class="hover:text-accent transition-colors duration-300">
                  {{ product.title }}
                </a>
              </h3>

              {%- if section.settings.show_description and product.description != blank -%}
                <p class="text-muted text-sm line-clamp-2">
                  {{ product.description | strip_html | truncatewords: 20 }}
                </p>
              {%- endif -%}

              <!-- Price -->
              <div class="flex items-center gap-3">
                <span class="text-2xl font-bold bg-flux-gradient bg-clip-text text-transparent">
                  {{ product.price | money }}
                </span>
                
                {%- if product.compare_at_price > product.price -%}
                  <span class="text-sm text-muted line-through">
                    {{ product.compare_at_price | money }}
                  </span>
                {%- endif -%}
              </div>

              <!-- CTA Button -->
              {%- if section.settings.show_cta -%}
                <a 
                  href="{{ product.url }}" 
                  class="btn btn-primary w-full text-center group-hover:shadow-glow-lg transition-all duration-300"
                >
                  {%- if has_3d_model -%}
                    {{ 'products.product.view_3d_model' | t }}
                  {%- else -%}
                    {{ 'products.product.view_product' | t }}
                  {%- endif -%}
                </a>
              {%- endif -%}

              <!-- 3D Badge -->
              {%- if has_3d_model -%}
                <div class="flex items-center justify-center gap-2 text-accent text-sm font-semibold">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                  </svg>
                  {{ 'products.product.3d_available' | t }}
                </div>
              {%- endif -%}
            </div>
          </div>
        {%- endif -%}
      {%- endfor -%}
    </div>

    <!-- Section CTA -->
    {%- if section.settings.button_text != blank -%}
      <div class="text-center mt-16 animate-fade-in-up">
        <a href="{{ section.settings.button_link }}" class="btn btn-primary btn-lg">
          {{ section.settings.button_text }}
        </a>
      </div>
    {%- endif -%}
  </div>
</section>

<!-- Load Shopify's Model Viewer -->
<script type="module" src="https://cdn.shopify.com/shopifycloud/model-viewer-ui/assets/v1.0/model-viewer.js"></script>

<script>
  // Initialize 3D Model Viewers
  document.addEventListener('DOMContentLoaded', function() {
    const modelViewers = document.querySelectorAll('model-viewer');
    
    modelViewers.forEach((viewer) => {
      // Add loading state
      viewer.addEventListener('load', function() {
        console.log('3D model loaded successfully');
      });

      // Handle errors
      viewer.addEventListener('error', function(error) {
        console.error('Error loading 3D model:', error);
      });

      // AR button interaction
      viewer.addEventListener('ar-status', function(event) {
        if (event.detail.status === 'not-presenting') {
          console.log('AR not available on this device');
        }
      });
    });
  });
</script>

{% schema %}
{
  "name": "3D Product Showcase",
  "tag": "section",
  "class": "product-3d-showcase-section",
  "settings": [
    {
      "type": "paragraph",
      "content": "Showcase products with 3D models and AR support. Products must have 3D models uploaded (GLB/USDZ format) to display the 3D viewer."
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Experience in 3D"
    },
    {
      "type": "textarea",
      "id": "subheading",
      "label": "Subheading",
      "default": "Interact with our products in stunning 3D and see them in your space with AR"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 1,
      "max": 3,
      "step": 1,
      "label": "Columns on desktop",
      "default": 3,
      "info": "Recommended: 2-3 for optimal 3D model viewing"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show vendor",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "label": "Show product description",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_cta",
      "label": "Show call-to-action button",
      "default": true
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Section button text",
      "info": "Main button at bottom of section"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Section button link"
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "3D Product",
      "limit": 6,
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product",
          "info": "Select a product with 3D models uploaded"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "3D Product Showcase",
      "blocks": [
        {
          "type": "product"
        },
        {
          "type": "product"
        },
        {
          "type": "product"
        }
      ]
    }
  ]
}
{% endschema %}

