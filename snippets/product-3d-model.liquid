{% comment %}
  Renders a 3D model viewer for a product media item
  
  Accepts:
  - media: {Object} Media Liquid object (required)
  - loop: {Boolean} Auto-rotate model (optional)
  - reveal: {String} 'auto' or 'interaction' (optional)
  
  Usage:
  {% render 'product-3d-model', media: media, loop: true, reveal: 'interaction' %}
{% endcomment %}

{%- liquid
  assign loop_setting = loop | default: false
  assign reveal_setting = reveal | default: 'interaction'
-%}

<div class="product-3d-model-wrapper relative w-full h-full group" data-media-id="{{ media.id }}">
  
  <!-- 3D Model Viewer -->
  {{ media | model_viewer_tag:
    image_size: '1024x',
    reveal: reveal_setting,
    toggleable: true,
    data-model-id: media.id,
    interaction-prompt-threshold: 0,
    ar: true,
    ar-modes: 'webxr scene-viewer quick-look',
    camera-controls: true,
    auto-rotate: loop_setting,
    loading: 'lazy',
    poster: media.preview_image | image_url: width: 1024,
    alt: media.alt | escape,
    class: 'w-full h-full'
  }}

  <!-- AR Button (For Mobile Devices) -->
  <button
    slot="ar-button"
    class="absolute bottom-6 left-1/2 -translate-x-1/2 px-6 py-3 bg-flux-gradient text-white font-semibold rounded-xl shadow-glow hover:shadow-glow-lg transition-all duration-300 flex items-center gap-2 opacity-0 group-hover:opacity-100 md:opacity-100"
    type="button"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
    </svg>
    <span class="text-sm font-bold">{{ 'products.product.view_in_space' | t }}</span>
  </button>

  <!-- 3D Badge -->
  <div class="absolute top-4 right-4 px-3 py-2 bg-accent text-white text-xs font-bold rounded-lg shadow-lg flex items-center gap-2 z-10">
    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
    </svg>
    3D
  </div>

  <!-- Instructions Tooltip -->
  <div class="absolute top-4 left-4 px-4 py-2 bg-secondary/95 backdrop-blur-sm border border-accent/30 rounded-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 max-w-xs">
    <p class="text-xs text-muted">
      <strong class="text-accent block mb-1">{{ 'products.product.3d_controls' | t }}</strong>
      {{ 'products.product.3d_instructions' | t }}
    </p>
  </div>

  <!-- Loading Indicator -->
  <div class="absolute inset-0 flex items-center justify-center pointer-events-none model-loading">
    <div class="w-12 h-12 border-4 border-accent/20 border-t-accent rounded-full animate-spin"></div>
  </div>
</div>

<style>
  model-viewer[loaded] ~ .model-loading {
    display: none;
  }
  
  .product-3d-model-wrapper model-viewer {
    --poster-color: transparent;
    --progress-bar-color: #7F5AF0;
  }
</style>

<script>
  // Enhanced 3D Model Viewer Functionality
  (function() {
    const modelWrapper = document.querySelector('[data-media-id="{{ media.id }}"]');
    if (!modelWrapper) return;

    const modelViewer = modelWrapper.querySelector('model-viewer');
    if (!modelViewer) return;

    // Track loading state
    modelViewer.addEventListener('load', function() {
      console.log('3D Model loaded:', '{{ media.id }}');
      
      // Add loaded class for custom styling
      this.classList.add('model-loaded');
    });

    // Error handling
    modelViewer.addEventListener('error', function(error) {
      console.error('Error loading 3D model:', error);
      
      // Show fallback message
      const fallback = document.createElement('div');
      fallback.className = 'absolute inset-0 flex items-center justify-center bg-secondary';
      fallback.innerHTML = `
        <div class="text-center p-6">
          <svg class="w-16 h-16 mx-auto mb-4 text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <p class="text-muted">Unable to load 3D model</p>
        </div>
      `;
      modelWrapper.appendChild(fallback);
    });

    // AR status tracking
    modelViewer.addEventListener('ar-status', function(event) {
      if (event.detail.status === 'session-started') {
        console.log('AR session started');
      }
    });

    // Camera change tracking (for analytics)
    modelViewer.addEventListener('camera-change', function() {
      // User is interacting with the model
      this.setAttribute('data-interacted', 'true');
    });
  })();
</script>

